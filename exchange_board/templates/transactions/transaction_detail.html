{% extends 'base.html' %}

{% block content %}

    <h1>Transaction Detail</h1>

    <div class="container mt-4 mb-4">
        <h2>Offer by: {{ offer.author.username }}</h2>
        <h2>Accepted by: {{ accepting_user.username }}</h2>
        <p class="lead">–¢–µ–±—è –∑–æ–≤—É—Ç: {{ request.user.username }}</p>
        <p class="lead">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π –º–µ–∂–¥—É —Å—Ç–æ—Ä–æ–Ω–∞–º–∏: {{ handshakes }}</p>
        <div class="handshake-chain">
            <span class="emoji">üë§</span> <!-- –Ω–∞—á–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
            {% for i in handshake_range %}
                <span class="line">‚îÄ</span>
                <span class="emoji">üë§</span>
            {% endfor %}
    </div>

    {% if author_not_asserts_paid %}
        {% if current_user_is_author %}

            <div class="text-border-block">
                –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ {{ transaction.accepting_user.username|capfirst }} <strong>{{ offer.amount_offered|floatformat:2 }} {{ offer.currency_offered }}</strong>
                <br>
                <strong>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</strong> {{ accepting_user_bank_detail.bank_name }}
                <br>
                <strong>–°—á–µ—Ç –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</strong> {{ accepting_user_bank_detail.account_or_phone }}
                <br>
                <strong>–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</strong> {{ accepting_user_bank_detail.recipient_name }}
                <br>
                <strong>{{ transaction.accepting_user.username|capfirst }} –ø–µ—Ä–µ–≤–µ–¥–µ—Ç –≤–∞–º –≤ –æ—Ç–≤–µ—Ç:</strong> {{ required_amount|floatformat:2 }} {{ offer.currency_needed }}

            </div>

            {% if transaction.author_uploads_transfer_screenshot %}
                <a href="{% url 'author_asserts_transfer_done' transaction.id %}" class="btn btn-minimalist">Stage 1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –≤—ã —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥</a>
            {% else %}
                <div class="text-border-block" style="background-color: #555A64; color: white;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ ‚¨á</div>
            {% endif %}

            <form action="{% url 'author_uploads_screenshot' transaction.id %}" method="post" enctype="multipart/form-data" class="mb-3">
                {% csrf_token %}
                <div class="form-group">
                    <label>–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ</label>
                    <input type="file" name="author_uploads_transfer_screenshot" class="form-control-file" onchange="displayImage(this, 'authorUploadedScreenshot')">
                </div>
                <button type="submit" class="btn btn-minimalist">Upload Screenshot</button>
                <img id="authorUploadedScreenshot" src="" alt="Uploaded Screenshot" style="display: none; width: 300px;">

            </form>

        {% elif current_user_is_accepting_user %}
            <div class="text-border-block" style="background-color: #555A64; color: white;">
                Stage 1. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–µ–Ω–µ–≥ –æ—Ç –∞–≤—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏.
            </div>
        {% endif %}

    {% elif author_asserts_paid and accepting_user_not_confirmed %}
        {% if current_user_is_author %}
            <div class="text-border-block" >
                Stage 2. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞.
            </div>
        {% elif current_user_is_accepting_user %}
            <div class="text-border-block" >
                Stage 2. –ê–≤—Ç–æ—Ä –∑–∞—è–≤–∫–∏ —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ <br>
                —Å–¥–µ–ª–∞–ª –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å—É–º–º—É: {{ offer.amount_offered|floatformat:2 }} {{ offer.currency_offered }}.
            </div>


                <div class="alert alert-warning" role="alert">
                –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ {{ offer.author|capfirst }} <strong>{{ required_amount|floatformat:2 }} {{ offer.currency_needed }}</strong>
                <br>
                <strong>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</strong> {{ offer.bank_detail.bank_name }}
                <br>
                <strong>C—á–µ—Ç –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω:</strong> {{ offer.bank_detail.account_or_phone }}
                <br>
                <strong>–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</strong> {{ offer.bank_detail.recipient_name }}
                <br>
                </div>

            <a href="{% url 'accepting_user_confirms_money_received' transaction.id %}" class="btn btn-minimalist">Stage 2. –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞</a>
            <br>
            {% if transaction.author_uploads_transfer_screenshot %}
                <img src="{{ transaction.author_uploads_transfer_screenshot.url }}" alt="Screenshot from author" width="300" class="img-thumbnail mb-3">
            {% else %}
                <p>No screenshot uploaded by the author yet.</p>
            {% endif %}

        {% endif %}

    {% elif accepting_user_confirmed_but_not_paid_back %}
        {% if current_user_is_author %}
            <div class="text-border-block">
                Stage 3. –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞.
            </div>
            <p>–î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ –æ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞.</p>
            <a href="{% url 'author_confirms_money_received' transaction.id %}" class="btn btn-info">–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞</a>

        {% elif current_user_is_accepting_user %}
            <div class="text-border-block">
                Stage 3. –°–¥–µ–ª–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å—á–µ—Ç –∞–≤—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏ {{ transaction.offer.author.username }}.
            </div>

            <div class="alert alert-warning" role="alert">
                <strong>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∞–≤—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏:</strong>
                <ul>
                    <li>–ë–∞–Ω–∫: {{ transaction.offer.bank_detail.bank_name }}</li>
                    <li>–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω: {{ transaction.offer.bank_detail.account_or_phone }}</li>
                    <li>–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è: {{ transaction.offer.bank_detail.recipient_name }}</li>
                    <li>–í–∞–ª—é—Ç–∞: {{ required_amount|floatformat:2 }} {{ transaction.offer.bank_detail.currency }}</li>
                </ul>
            </div>

            {% if transaction.accepting_user_uploads_transfer_screenshot %}
                <a href="{% url 'accepting_user_asserts_transfer_done' transaction.id %}" class="btn btn-info" style="background-color: #555A64; color: white;">Stage 3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –≤—ã —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥</a>
            {% else %}
                <div class="text-border-block">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ ‚¨á</div>
            {% endif %}

            <form action="{% url 'accepting_user_uploads_screenshot' transaction.id %}" method="post" enctype="multipart/form-data" class="mb-3">
                {% csrf_token %}
                <div class="form-group">
                    <label>–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ</label>
                    <input type="file" name="accepting_user_uploads_transfer_screenshot" class="form-control-file" onchange="displayImage(this, 'acceptingUserUploadedScreenshot')">
                </div>
                <button type="submit" class="btn btn-minimalist">Upload Screenshot</button>
                <img id="acceptingUserUploadedScreenshot" src="" alt="Uploaded Screenshot" style="display: none; width: 300px;">
            </form>

<!--            <a href="{% url 'accepting_user_asserts_transfer_done' transaction.id %}" class="btn btn-info">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –≤—ã —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥</a>-->
        {% endif %}

    {% elif accepting_user_paid_back_author_not_confirmed %}
        {% if current_user_is_author %}
            <a href="{% url 'author_confirms_money_received' transaction.id %}" class="btn btn-info">Stage 4  –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞</a>
            <div class="alert alert-info" role="alert">
                Stage 4 –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ —Å–æ–≤–µ—Ä—à–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞: {{ required_amount|floatformat:2 }} {{ offer.currency_needed }}.
            </div>
            {% if transaction.accepting_user_uploads_transfer_screenshot %}
                <img src="{{ transaction.accepting_user_uploads_transfer_screenshot.url }}" alt="Screenshot from accepting user" width="300" class="img-thumbnail mb-3">
            {% else %}
                <p>No screenshot uploaded by the accepting user yet.</p>
            {% endif %}

        {% elif current_user_is_accepting_user %}
            <div class="alert alert-info" role="alert">
                Stage 4 –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞.
            </div>
        {% endif %}

    {% elif accepting_user_author_both_confirmed %}
        <div class="alert alert-success" role="alert">
            Stage 5. –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
        </div>
        {% if existing_rating %}
            <a href="{% url 'rate_after_transaction' transaction.id %}" class="btn btn-primary">–ò–∑–º–µ–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É</a>
        {% else %}
            <a href="{% url 'rate_after_transaction' transaction.id %}" class="btn btn-primary">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</a>
        {% endif %}
    {% endif %}

<script>
function displayImage(fileInput, imgElementId) {
    var file = fileInput.files[0];
    var reader = new FileReader();

    reader.onloadend = function() {
        document.getElementById(imgElementId).style.display = "block";
        document.getElementById(imgElementId).src = reader.result;
    }

    if (file) {
        reader.readAsDataURL(file);
    } else {
        document.getElementById(imgElementId).style.display = "none";
    }
}
</script>
{% endblock %}
        