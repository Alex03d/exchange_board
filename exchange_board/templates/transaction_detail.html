<!-- transaction_detail.html -->

{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <h1>Transaction Detail</h1>

    <div class="mb-4">
    <h2>Offer by: {{ offer.author.username }}</h2>
    <h2>Accepted by: {{ accepting_user.username }}</h2>
    <p class="lead">–¢–µ–±—è –∑–æ–≤—É—Ç: {{ request.user.username }}</p>
    <p class="lead">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π –º–µ–∂–¥—É —Å—Ç–æ—Ä–æ–Ω–∞–º–∏: {{ handshakes }}</p>
        <div class="handshake-chain">
            <span class="emoji">üë§</span> <!-- –Ω–∞—á–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
            {% for i in handshake_range %}
                <span class="line">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
                <span class="emoji">üë§</span>
            {% endfor %}
        </div>
    </div>

    <style>
        .handshake-chain {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .emoji {
            font-size: 1.5em;
        }

        .line {
            margin: 0 5px;
        }
    </style>

    {% if transaction.author_asserts_transfer_done == 'no' %}
        {% if request.user.id == transaction.offer.author.id %}
            <div class="alert alert-warning" role="alert">
                –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ {{ transaction.accepting_user.username }}
            </div>

            <form action="{% url 'author_uploads_screenshot' transaction.id %}" method="post" enctype="multipart/form-data" class="mb-3">
                {% csrf_token %}
                <div class="form-group">
                    <label>–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ</label>
                    <input type="file" name="author_uploads_transfer_screenshot" class="form-control-file" onchange="displayImage(this, 'authorUploadedScreenshot')">
                </div>
                <img id="authorUploadedScreenshot" src="" alt="Uploaded Screenshot" style="display: none; width: 300px;">
                <button type="submit" class="btn btn-primary">Upload Screenshot</button>
            </form>

            <a href="{% url 'author_asserts_transfer_done' transaction.id %}" class="btn btn-info">Stage 1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –≤—ã —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥</a>

        {% elif request.user.id == transaction.accepting_user.id %}
            <div class="alert alert-info" role="alert">
                Stage 1. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–µ–Ω–µ–≥ –æ—Ç –∞–≤—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏.
            </div>
        {% endif %}

    {% elif transaction.author_asserts_transfer_done == 'YES' and transaction.accepting_user_confirms_money_received == 'no' %}
        {% if request.user == transaction.offer.author %}
            <div class="alert alert-info" role="alert">
                Stage 2. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞.
            </div>

        {% elif request.user == transaction.accepting_user %}
            <div class="alert alert-info" role="alert">
                Stage 2. –ê–≤—Ç–æ—Ä –∑–∞—è–≤–∫–∏ —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ —Å–¥–µ–ª–∞–ª –ø–µ—Ä–µ–≤–æ–¥.
            </div>
            {% if transaction.author_uploads_transfer_screenshot %}
                <img src="{{ transaction.author_uploads_transfer_screenshot.url }}" alt="Screenshot from author" width="300" class="img-thumbnail mb-3">
            {% else %}
                <p>No screenshot uploaded by the author yet.</p>
            {% endif %}

            <a href="{% url 'accepting_user_confirms_money_received' transaction.id %}" class="btn btn-info">Stage 2. –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞</a>
        {% endif %}

    {% elif transaction.accepting_user_confirms_money_received == 'YES' and transaction.author_money_confirms_received == 'no' and transaction.accepting_user_asserts_transfer_done == 'no' %}
        {% if request.user == transaction.offer.author %}
            <div class="alert alert-info" role="alert">
                Stage 3. –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞.
            </div>
            <p>–î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ –æ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞.</p>
            <a href="{% url 'author_confirms_money_received' transaction.id %}" class="btn btn-info">–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞</a>

        {% elif request.user == transaction.accepting_user %}
            <div class="alert alert-warning" role="alert">
                Stage 3. –°–¥–µ–ª–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å—á–µ—Ç –∞–≤—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏ {{ transaction.offer.author.username }}.
            </div>

            <form action="{% url 'accepting_user_uploads_screenshot' transaction.id %}" method="post" enctype="multipart/form-data" class="mb-3">
                {% csrf_token %}
                <div class="form-group">
                    <label>–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ</label>
                    <input type="file" name="accepting_user_uploads_transfer_screenshot" class="form-control-file" onchange="displayImage(this, 'acceptingUserUploadedScreenshot')">
                </div>
                <img id="acceptingUserUploadedScreenshot" src="" alt="Uploaded Screenshot" style="display: none; width: 300px;">
                <button type="submit" class="btn btn-primary">Upload Screenshot</button>
            </form>

            <a href="{% url 'accepting_user_asserts_transfer_done' transaction.id %}" class="btn btn-info">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –≤—ã —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥</a>
        {% endif %}

    {% elif transaction.accepting_user_confirms_money_received == 'YES' and transaction.author_money_confirms_received == 'no' and transaction.accepting_user_asserts_transfer_done == 'YES' %}
        {% if request.user == transaction.offer.author %}
            <div class="alert alert-info" role="alert">
                Stage 4 –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ —Å–æ–≤–µ—Ä—à–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞.
            </div>
            {% if transaction.accepting_user_uploads_transfer_screenshot %}
                <img src="{{ transaction.accepting_user_uploads_transfer_screenshot.url }}" alt="Screenshot from accepting user" width="300" class="img-thumbnail mb-3">
            {% else %}
                <p>No screenshot uploaded by the accepting user yet.</p>
            {% endif %}

            <a href="{% url 'author_confirms_money_received' transaction.id %}" class="btn btn-info">Stage 4  –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞</a>

        {% elif request.user == transaction.accepting_user %}
            <div class="alert alert-info" role="alert">
                Stage 4 –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞.
            </div>
        {% endif %}

    {% elif transaction.accepting_user_confirms_money_received == 'YES' and transaction.author_money_confirms_received == 'YES' %}
        <div class="alert alert-success" role="alert">
            Stage 5. –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
        </div>
    {% endif %}
</div>

<script>
function displayImage(fileInput, imgElementId) {
    var file = fileInput.files[0];
    var reader = new FileReader();

    reader.onloadend = function() {
        document.getElementById(imgElementId).style.display = "block";
        document.getElementById(imgElementId).src = reader.result;
    }

    if (file) {
        reader.readAsDataURL(file);
    } else {
        document.getElementById(imgElementId).style.display = "none";
    }
}
</script>
{% endblock %}
